function calculateProjection(e){"use strict";var t,n,r,i,s,o,u,a,f;o=d3.geo.conicConformal().scale(1);u=Infinity;a=1;f=0;while(u>1&&f<10){s=d3.geo.path().projection(o);t=s.bounds(e);n=[(t[0][0]+t[1][0])/2,(t[0][1]+t[1][1])/2];n=o.invert(n);r=o.scale()*vv.width/(t[1][0]-t[0][0]);i=o.scale()*vv.height/(t[1][1]-t[0][1]);o.scale(Math.min(i,r)*.75).rotate([-n[0],-n[1],0]);o.translate([vv.width/2,vv.height/2]);u=Math.abs(o.scale()-a);a=o.scale();f++}return o}function drawRoute(e){"use strict";var t,n,r,i,s,o,u,a;o=d3.scale.category10();e=JSON.parse(e);i={type:"LineString",coordinates:[]};for(t=0;t<e.length;t++)i.coordinates.push([parseFloat(e[t].lon),parseFloat(e[t].lat)]);d3.select(".trip-map svg").remove();vv.svg=d3.select(".trip-map").append("svg");vv.width=jQuery(".trip-map").width();vv.height=jQuery(".trip-map").height();vv.g=vv.svg.append("g");vv.projection=calculateProjection(i);s=d3.geo.path().projection(vv.projection);n=vv.g.append("g").attr("class","viaje");r=n.append("g");n.append("path").datum(i).attr("class","route").attr("d",s);n.selectAll("circle").data(i.coordinates).enter().append("circle").attr("cx",function(e){return vv.projection(e)[0]}).attr("cy",function(e){return vv.projection(e)[1]}).attr("r","5px");d3.json(basepath+"data/countries-50m-topojson.json",function(e){u=topojson.neighbors(e.objects.world.geometries);a=topojson.feature(e,e.objects.world).features;vv.svg.attr("width",vv.width).attr("height",vv.height);vv.aspectratio=vv.width/vv.height;r.append("path").datum(topojson.mesh(e,e.objects.world,function(e,t){return e===t})).attr("d",s).attr("class","coast");r.append("path").datum(topojson.mesh(e,e.objects.world,function(e,t){return e!==t})).attr("d",s).attr("class","boundary");r.selectAll(".country").data(a).enter().insert("path",".graticule").attr("class","country").attr("d",s).style("fill",function(e,t){e.color=d3.max(u[t],function(e){return a[e].color})+1|0;return o(e.color)})});n.append("path").datum(d3.geo.graticule()).attr("class","graticule").attr("d",s)}var basepath=kmc2_visualization_vars.basepath,ajaxUrl=kmc2_visualization_vars.siteurl+"wp-admin/admin-ajax.php",category_id=kmc2_visualization_vars.category_id,vv={};jQuery(document).ready(function(){"use strict";vv.mult=1;jQuery.ajax({type:"POST",url:ajaxUrl+"?action=kmc2_trip_places",data:{cat:category_id},success:drawRoute})});jQuery(window).resize(function(){"use strict";vv.mult=jQuery(".trip-map svg").width()/vv.width;vv.svg.attr("width",vv.width*vv.mult).attr("height",vv.height*vv.mult);vv.g.transition().duration(750).attr("transform","scale("+vv.mult+")")});